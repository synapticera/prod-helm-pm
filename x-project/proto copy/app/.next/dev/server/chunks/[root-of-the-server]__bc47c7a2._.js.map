{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///Users/wkarp/devlocal/prod-miner-pm/x-project/proto/app/lib/ai/provider.ts"],"sourcesContent":["import { createAnthropic } from '@ai-sdk/anthropic';\n\n// Create Anthropic provider instance\n// Uses ANTHROPIC_API_KEY from environment\nexport const anthropic = createAnthropic({\n  // API key is automatically read from ANTHROPIC_API_KEY env var\n});\n\n// Default model for the CS Advisor\nexport const defaultModel = anthropic('claude-sonnet-4-20250514');\n\n// For future: factory pattern to support multiple providers\nexport type AIProviderType = 'anthropic' | 'openai' | 'vertex';\n\nexport function getModel(provider: AIProviderType = 'anthropic') {\n  switch (provider) {\n    case 'anthropic':\n      return defaultModel;\n    // Future: add other providers\n    // case 'openai':\n    //   return openai('gpt-4o');\n    // case 'vertex':\n    //   return vertex('gemini-1.5-pro');\n    default:\n      return defaultModel;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;;AAIO,MAAM,YAAY,IAAA,+MAAe,EAAC;AAEzC;AAGO,MAAM,eAAe,UAAU;AAK/B,SAAS,SAAS,WAA2B,WAAW;IAC7D,OAAQ;QACN,KAAK;YACH,OAAO;QACT,8BAA8B;QAC9B,iBAAiB;QACjB,6BAA6B;QAC7B,iBAAiB;QACjB,qCAAqC;QACrC;YACE,OAAO;IACX;AACF"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///Users/wkarp/devlocal/prod-miner-pm/x-project/proto/app/lib/ai/system-prompt.ts"],"sourcesContent":["export const CS_ADVISOR_SYSTEM_PROMPT = `You are an expert AI advisor helping Customer Service executives understand what's possible with AI in their service operations. Your role is to educate, inform, and help them discover opportunities - NOT to sell.\n\n## Your Persona\n\n- **Knowledgeable but approachable** - You know the space deeply but explain things simply\n- **Honest about limitations** - AI can't do everything; be upfront about what works and what doesn't\n- **Curious about their situation** - Ask good questions, listen carefully\n- **Educational first** - Your goal is to help them learn, not to qualify them as leads\n\n## Available Tools\n\nYou have access to these tools to create interactive UI components:\n\n1. **showQuestion** - Display multiple choice questions. Use this for ALL discovery questions.\n2. **showEducation** - Display educational content with key points and drill-down options.\n3. **showBenchmarks** - Display industry-specific metrics and benchmarks.\n4. **showOpportunities** - Display tactical and strategic AI opportunities with ROI estimates.\n5. **showRoadmap** - Display quarterly implementation roadmap.\n6. **showSummary** - Display summary sections.\n7. **searchWeb** - Search the web for company information, industry data, and current stats.\n\n## Conversation Flow\n\n### Phase 0: Upfront Discovery (ALWAYS START HERE)\n\nBefore diving into the conversation, gather basic information to personalize the entire experience.\n\n**Step 1: Get Their Name**\nStart with a warm welcome and ask for their name. Use showQuestion with inputType: \"text\":\n- Header: \"Welcome\"\n- Question: \"Hi! I'm your AI advisor for exploring customer service opportunities. Before we begin, what should I call you?\"\n- inputType: \"text\"\n- placeholder: \"Your name\"\n\nWhen the user responds with their name (e.g., \"John\"), immediately proceed to Step 2. Store their name using updateContext.\n\n**Step 2: Get Their Role**\nUse showQuestion (inputType: \"select\") to ask about their role:\n- Header: \"Your Role\"\n- Question: \"Great to meet you, [NAME]! What's your role in the organization?\"\n- options: [\n    { id: \"vp_director\", label: \"VP/Director of Customer Service/Support\", description: \"Operational leader focused on team efficiency and metrics\" },\n    { id: \"cxo\", label: \"Chief Customer Officer / CXO\", description: \"Strategic executive focused on customer experience transformation\" },\n    { id: \"ops\", label: \"CS Operations / Enablement\", description: \"Focused on tools, processes, and team productivity\" }\n  ]\n\nWhen the user selects a role, store it using updateContext and proceed to Step 3.\n\n**Step 3: Get Their Company Domain**\nUse showQuestion (inputType: \"text\") to ask for their company domain:\n- Header: \"Your Company\"\n- Question: \"What's your company's website domain? (e.g., acme.com) This helps me tailor the conversation to your industry.\"\n- inputType: \"text\"\n- placeholder: \"company.com\"\n\nWhen the user responds with a domain, proceed to Step 4.\n\n**Step 4: Research & Confirm Industry**\nAfter getting the domain:\n1. Use searchWeb to research their company:\n   - What industry they're in\n   - Company size (if findable)\n   - What they sell/do\n   - Any public info about their customer service model\n2. Summarize what you found and confirm:\n   - \"Based on what I found, [COMPANY] appears to be a [INDUSTRY] company that [BRIEF DESCRIPTION]. Is that accurate?\"\n3. If they correct you, update your understanding\n\n**Step 5: Where They Want to Apply AI**\nThis is a KEY branching question. Use showQuestion with allowMultiple: true:\n- Header: \"AI Focus Areas\"\n- Question: \"Where are you most interested in applying AI? (Select all that apply)\"\n- allowMultiple: true\n- Options:\n  - { id: \"product\", label: \"In the Product Experience\", description: \"AI features your customers interact with directly\" }\n  - { id: \"service\", label: \"In the Service Experience\", description: \"AI to help your support team serve customers better\" }\n  - { id: \"operations\", label: \"In Internal Operations\", description: \"AI to streamline back-office processes and workflows\" }\n\nBased on their selection, tailor the rest of the conversation:\n- **Product**: Focus on customer-facing AI, chatbots, self-service, proactive support\n- **Service**: Focus on agent copilots, knowledge assist, ticket routing, quality assurance\n- **Operations**: Focus on automation, analytics, forecasting, workforce management\n- **Multiple areas**: Cover all selected areas, noting connections between them\n\n**Step 6: Route Their Journey**\nNow use showQuestion to understand their learning preference:\n- Header: \"What's Helpful\"\n- Question: \"Thanks, [NAME]! What would be most valuable for you right now?\"\n- Options:\n  - \"Help me learn\" - I'm exploring what AI can do in customer service. Educate me.\n  - \"Assess my situation\" - I understand the basics. Help me find opportunities specific to my operation.\n  - \"Both\" - Start with education, then help me assess where I can apply it.\n\n**IMPORTANT**: Always use the person's name throughout the conversation after learning it. Adapt your language based on their role:\n- **VP/Director**: Focus on metrics, team productivity, tactical wins\n- **CXO**: Focus on competitive advantage, transformation, strategic positioning\n- **Operations**: Focus on tools, workflows, implementation details\n\n### Phase 1: Welcome & Discovery (After Upfront)\n\nContinue gathering context through questions:\n\n1. **Customer Type** - B2B vs B2C vs Both vs Internal\n2. **Interest Path** - \"Help me learn\" vs \"Assess my situation\" vs \"Both\"\n\n### Phase 2: Education Path (if selected)\n\nCover these topics, offering drill-downs:\n\n1. **Three Levels of AI**: Chatbots, Agent Copilots, Autonomous Agents\n2. **Where AI Works vs Struggles**: Strengths and limitations\n3. **Industry Benchmarks**: Use their industry for relevant stats\n4. **Common Questions**: ROI expectations, costs, timeline, risks\n5. **Security & Compliance**: Enterprise requirements\n\n### Phase 3: Assessment Path\n\nGather specific operational data through showQuestion:\n\n1. **Monthly ticket volume** - Use inputType: \"select\" with ranges\n2. **Support channels** - Use allowMultiple: true (companies use multiple channels)\n   - Options: Email, Phone, Chat, Social Media, Self-Service Portal, etc.\n3. **Team size** - Use inputType: \"select\" with ranges\n4. **Primary pain points** - Use allowMultiple: true (multiple pain points)\n5. **Current platforms** - **ALWAYS use allowMultiple: true** (companies often use multiple tools)\n   - Options: Zendesk, Salesforce Service Cloud, Freshdesk, Intercom, HubSpot, Custom/Internal, Other\n6. **Data/categorization state** - How well are tickets categorized today?\n\n**IMPORTANT for multi-select questions**: Set allowMultiple: true in the showQuestion parameters. This shows checkboxes instead of radio buttons and lets users select multiple options before submitting.\n\n### Phase 4: Results\n\nBased on assessment, provide:\n- Opportunity map (tactical + strategic)\n- ROI estimates\n- Priority recommendations\n- Quarterly roadmap\n- Platform-specific guidance\n\n## Important Guidelines\n\n1. **Tools ONLY, no text** - When using a tool like showQuestion, showEducation, etc., do NOT output any text before or after the tool call. The tool renders the UI; text would be redundant. Only output text if you need to say something without a tool.\n2. **One step at a time** - Don't overwhelm. Ask one question, wait for response, then proceed.\n3. **Be honest about ROI** - Vendor claims are optimistic. Year 1 is often break-even.\n4. **Adapt to their level** - CXOs want strategy, VPs want tactics, Ops wants implementation details.\n5. **Offer exports** - At the end, offer to summarize everything they can share with their team.\n6. **User responses are answers** - When a user responds after a showQuestion tool, their message IS their answer to that question. Process it accordingly and move to the next step.\n\n## ROI Framing\n\nAlways frame ROI conservatively:\n- Year 1 = foundation building, often break-even\n- Years 2-3 = compounding value\n- Vendor claims are cherry-picked; set realistic expectations\n\n## Start the Conversation\n\nDO NOT output any text. Immediately use the showQuestion tool to ask for their name (this is Step 1 of Upfront Discovery). The question card itself contains the welcome message.`;\n"],"names":[],"mappings":";;;;AAAO,MAAM,2BAA2B,CAAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;iLA6JwI,CAAC"}},
    {"offset": {"line": 230, "column": 0}, "map": {"version":3,"sources":["file:///Users/wkarp/devlocal/prod-miner-pm/x-project/proto/app/lib/ai/tools.ts"],"sourcesContent":["import { z } from 'zod';\n\n// Tool parameter schemas\nexport const questionSchema = z.object({\n  header: z.string().describe('Short label for the question category'),\n  question: z.string().describe('The full question to ask the user'),\n  inputType: z.enum(['select', 'text']).optional().describe('Type of input: select for multiple choice, text for free-form input. Defaults to select.'),\n  placeholder: z.string().optional().describe('Placeholder text for text input'),\n  options: z.array(z.object({\n    id: z.string().describe('Unique identifier for this option'),\n    label: z.string().describe('Display text for the option'),\n    description: z.string().optional().describe('Additional context for the option'),\n  })).optional().describe('2-4 answer options (required for select inputType)'),\n  allowMultiple: z.boolean().optional().describe('Allow selecting multiple options (only for select inputType)'),\n});\n\nexport const educationSchema = z.object({\n  title: z.string().describe('Topic title'),\n  content: z.string().describe('Main educational content (markdown supported)'),\n  keyPoints: z.array(z.string()).optional().describe('Bullet point key takeaways'),\n  drillDownOptions: z.array(z.string()).optional().describe('Topics user can explore deeper'),\n});\n\nexport const benchmarkSchema = z.object({\n  industry: z.string().describe('Industry name'),\n  metrics: z.array(z.object({\n    name: z.string().describe('Metric name'),\n    value: z.string().describe('Metric value'),\n    context: z.string().optional().describe('What this means'),\n  })).describe('Industry benchmark metrics'),\n  insights: z.array(z.string()).optional().describe('Key insights about this industry'),\n});\n\nexport const opportunitySchema = z.object({\n  tactical: z.array(z.object({\n    id: z.string(),\n    name: z.string(),\n    description: z.string(),\n    effort: z.enum(['Low', 'Medium', 'High']),\n    timeline: z.string(),\n    estimatedSavings: z.string(),\n  })).describe('Quick wins (30-90 days)'),\n  strategic: z.array(z.object({\n    id: z.string(),\n    name: z.string(),\n    description: z.string(),\n    effort: z.enum(['Low', 'Medium', 'High']),\n    timeline: z.string(),\n    estimatedSavings: z.string(),\n    prerequisites: z.array(z.string()).optional(),\n  })).describe('Longer-term initiatives (6-18 months)'),\n});\n\nexport const roadmapSchema = z.object({\n  quarters: z.array(z.object({\n    quarter: z.string().describe('Quarter label (e.g., \"Q1\")'),\n    title: z.string().describe('Quarter theme'),\n    initiatives: z.array(z.object({\n      name: z.string(),\n      description: z.string(),\n      milestone: z.string().optional(),\n    })),\n  })),\n});\n\nexport const summarySchema = z.object({\n  title: z.string(),\n  sections: z.array(z.object({\n    heading: z.string(),\n    content: z.string(),\n  })),\n});\n\nexport const searchWebSchema = z.object({\n  query: z.string().describe('Search query to find company info, industry data, or current statistics'),\n});\n\nexport const updateContextSchema = z.object({\n  name: z.string().optional().describe('User name'),\n  role: z.string().optional().describe('User role'),\n  company: z.string().optional().describe('Company name'),\n  domain: z.string().optional().describe('Company domain'),\n  industry: z.string().optional().describe('Industry/sub-industry'),\n});\n\n// Tool definitions for the AI\nexport const advisorTools = {\n  showQuestion: {\n    description: 'Display a multiple choice question to gather information from the user. Use this for all discovery questions.',\n    parameters: questionSchema,\n  },\n\n  showEducation: {\n    description: 'Display educational content about AI in customer service. Use for teaching concepts.',\n    parameters: educationSchema,\n  },\n\n  showBenchmarks: {\n    description: 'Display industry-specific benchmarks and metrics. Use after identifying their industry.',\n    parameters: benchmarkSchema,\n  },\n\n  showOpportunities: {\n    description: 'Display AI opportunities with ROI estimates. Use after completing assessment.',\n    parameters: opportunitySchema,\n  },\n\n  showRoadmap: {\n    description: 'Display quarterly implementation roadmap. Use after presenting opportunities.',\n    parameters: roadmapSchema,\n  },\n\n  showSummary: {\n    description: 'Display a summary or conclusion section.',\n    parameters: summarySchema,\n  },\n\n  searchWeb: {\n    description: 'Search the web for company information, industry data, or current statistics. Use to research a company by their domain.',\n    parameters: searchWebSchema,\n  },\n\n  updateContext: {\n    description: 'Store context about the user for personalizing the conversation. Call this after learning name, role, company, or industry.',\n    parameters: updateContextSchema,\n  },\n};\n\n// Type exports for components\nexport type QuestionParams = z.infer<typeof questionSchema>;\nexport type EducationParams = z.infer<typeof educationSchema>;\nexport type BenchmarkParams = z.infer<typeof benchmarkSchema>;\nexport type OpportunityParams = z.infer<typeof opportunitySchema>;\nexport type RoadmapParams = z.infer<typeof roadmapSchema>;\nexport type SummaryParams = z.infer<typeof summarySchema>;\nexport type SearchWebParams = z.infer<typeof searchWebSchema>;\nexport type UpdateContextParams = z.infer<typeof updateContextSchema>;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 387, "column": 0}, "map": {"version":3,"sources":["file:///Users/wkarp/devlocal/prod-miner-pm/x-project/proto/app/lib/storage/file-store.ts"],"sourcesContent":["import fs from 'fs/promises';\nimport path from 'path';\n\nconst DATA_DIR = path.join(process.cwd(), '..', 'data', 'sessions');\n\nexport interface SessionData {\n  id: string;\n  createdAt: string;\n  updatedAt: string;\n  phase: 'discovery' | 'education' | 'assessment' | 'results' | 'complete';\n  companyContext?: {\n    industry: string;\n    customerType: string;\n    size?: string;\n  };\n  userContext?: {\n    role: string;\n    interestPath: string;\n  };\n  assessmentData?: {\n    ticketVolume?: string;\n    channels?: string[];\n    teamSize?: string;\n    primaryPainPoint?: string;\n    platform?: string;\n    dataState?: string;\n  };\n  messages: Array<{\n    role: 'user' | 'assistant';\n    content: string;\n    timestamp: string;\n    toolCalls?: Array<{\n      name: string;\n      args: Record<string, unknown>;\n    }>;\n  }>;\n}\n\nexport async function ensureDataDir(): Promise<void> {\n  await fs.mkdir(DATA_DIR, { recursive: true });\n}\n\nexport async function saveSession(sessionId: string, data: SessionData): Promise<void> {\n  await ensureDataDir();\n  const filePath = path.join(DATA_DIR, `${sessionId}.json`);\n  await fs.writeFile(filePath, JSON.stringify(data, null, 2));\n}\n\nexport async function loadSession(sessionId: string): Promise<SessionData | null> {\n  try {\n    const filePath = path.join(DATA_DIR, `${sessionId}.json`);\n    const content = await fs.readFile(filePath, 'utf-8');\n    return JSON.parse(content);\n  } catch {\n    return null;\n  }\n}\n\nexport async function createSession(sessionId: string): Promise<SessionData> {\n  const session: SessionData = {\n    id: sessionId,\n    createdAt: new Date().toISOString(),\n    updatedAt: new Date().toISOString(),\n    phase: 'discovery',\n    messages: [],\n  };\n  await saveSession(sessionId, session);\n  return session;\n}\n\nexport async function appendMessage(\n  sessionId: string,\n  role: 'user' | 'assistant',\n  content: string,\n  toolCalls?: Array<{ name: string; args: Record<string, unknown> }>\n): Promise<void> {\n  const session = await loadSession(sessionId);\n  if (!session) {\n    throw new Error(`Session ${sessionId} not found`);\n  }\n\n  session.messages.push({\n    role,\n    content,\n    timestamp: new Date().toISOString(),\n    toolCalls,\n  });\n  session.updatedAt = new Date().toISOString();\n\n  await saveSession(sessionId, session);\n}\n\nexport async function updateSessionData(\n  sessionId: string,\n  updates: Partial<Omit<SessionData, 'id' | 'createdAt' | 'messages'>>\n): Promise<void> {\n  const session = await loadSession(sessionId);\n  if (!session) {\n    throw new Error(`Session ${sessionId} not found`);\n  }\n\n  Object.assign(session, updates);\n  session.updatedAt = new Date().toISOString();\n\n  await saveSession(sessionId, session);\n}\n\nexport async function listSessions(): Promise<string[]> {\n  try {\n    await ensureDataDir();\n    const files = await fs.readdir(DATA_DIR);\n    return files\n      .filter(f => f.endsWith('.json'))\n      .map(f => f.replace('.json', ''));\n  } catch {\n    return [];\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA;AACA;;;AAEA,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,MAAM,QAAQ;AAmCjD,eAAe;IACpB,MAAM,gIAAE,CAAC,KAAK,CAAC,UAAU;QAAE,WAAW;IAAK;AAC7C;AAEO,eAAe,YAAY,SAAiB,EAAE,IAAiB;IACpE,MAAM;IACN,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,UAAU,GAAG,UAAU,KAAK,CAAC;IACxD,MAAM,gIAAE,CAAC,SAAS,CAAC,UAAU,KAAK,SAAS,CAAC,MAAM,MAAM;AAC1D;AAEO,eAAe,YAAY,SAAiB;IACjD,IAAI;QACF,MAAM,WAAW,4GAAI,CAAC,IAAI,CAAC,UAAU,GAAG,UAAU,KAAK,CAAC;QACxD,MAAM,UAAU,MAAM,gIAAE,CAAC,QAAQ,CAAC,UAAU;QAC5C,OAAO,KAAK,KAAK,CAAC;IACpB,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,eAAe,cAAc,SAAiB;IACnD,MAAM,UAAuB;QAC3B,IAAI;QACJ,WAAW,IAAI,OAAO,WAAW;QACjC,WAAW,IAAI,OAAO,WAAW;QACjC,OAAO;QACP,UAAU,EAAE;IACd;IACA,MAAM,YAAY,WAAW;IAC7B,OAAO;AACT;AAEO,eAAe,cACpB,SAAiB,EACjB,IAA0B,EAC1B,OAAe,EACf,SAAkE;IAElE,MAAM,UAAU,MAAM,YAAY;IAClC,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM,CAAC,QAAQ,EAAE,UAAU,UAAU,CAAC;IAClD;IAEA,QAAQ,QAAQ,CAAC,IAAI,CAAC;QACpB;QACA;QACA,WAAW,IAAI,OAAO,WAAW;QACjC;IACF;IACA,QAAQ,SAAS,GAAG,IAAI,OAAO,WAAW;IAE1C,MAAM,YAAY,WAAW;AAC/B;AAEO,eAAe,kBACpB,SAAiB,EACjB,OAAoE;IAEpE,MAAM,UAAU,MAAM,YAAY;IAClC,IAAI,CAAC,SAAS;QACZ,MAAM,IAAI,MAAM,CAAC,QAAQ,EAAE,UAAU,UAAU,CAAC;IAClD;IAEA,OAAO,MAAM,CAAC,SAAS;IACvB,QAAQ,SAAS,GAAG,IAAI,OAAO,WAAW;IAE1C,MAAM,YAAY,WAAW;AAC/B;AAEO,eAAe;IACpB,IAAI;QACF,MAAM;QACN,MAAM,QAAQ,MAAM,gIAAE,CAAC,OAAO,CAAC;QAC/B,OAAO,MACJ,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ,CAAC,UACvB,GAAG,CAAC,CAAA,IAAK,EAAE,OAAO,CAAC,SAAS;IACjC,EAAE,OAAM;QACN,OAAO,EAAE;IACX;AACF"}},
    {"offset": {"line": 474, "column": 0}, "map": {"version":3,"sources":["file:///Users/wkarp/devlocal/prod-miner-pm/x-project/proto/app/app/api/chat/route.ts"],"sourcesContent":["import { streamText } from 'ai';\nimport { z } from 'zod';\nimport { defaultModel } from '@/lib/ai/provider';\nimport { CS_ADVISOR_SYSTEM_PROMPT } from '@/lib/ai/system-prompt';\nimport {\n  questionSchema,\n  educationSchema,\n  benchmarkSchema,\n  opportunitySchema,\n  roadmapSchema,\n  summarySchema,\n  searchWebSchema,\n  updateContextSchema,\n} from '@/lib/ai/tools';\nimport {\n  loadSession,\n  createSession,\n  appendMessage,\n  updateSessionData,\n} from '@/lib/storage/file-store';\n\nexport const maxDuration = 60;\n\nexport async function POST(req: Request) {\n  try {\n    const { messages, sessionId } = await req.json();\n\n    console.log('[API] Received request with', messages.length, 'messages, sessionId:', sessionId);\n    console.log('[API] Last message:', JSON.stringify(messages[messages.length - 1]).substring(0, 200));\n\n    // Ensure session exists\n    let session = await loadSession(sessionId);\n    if (!session) {\n      session = await createSession(sessionId);\n    }\n\n    // Get the last user message to save\n    const lastUserMessage = messages[messages.length - 1];\n    if (lastUserMessage?.role === 'user') {\n      await appendMessage(sessionId, 'user', lastUserMessage.content);\n    }\n\n    const result = await streamText({\n    model: defaultModel,\n    system: CS_ADVISOR_SYSTEM_PROMPT,\n    messages,\n    maxSteps: 5, // Allow multi-step tool calls (e.g., updateContext then showQuestion)\n    tools: {\n      showQuestion: {\n        description:\n          'Display a multiple choice question to gather information from the user. Use this for all discovery questions.',\n        parameters: questionSchema,\n        execute: async (args: z.infer<typeof questionSchema>) => {\n          // UI tool - just acknowledge for message history\n          return { displayed: true, type: 'question', header: args.header };\n        },\n      },\n\n      showEducation: {\n        description:\n          'Display educational content about AI in customer service. Use for teaching concepts.',\n        parameters: educationSchema,\n        execute: async (args: z.infer<typeof educationSchema>) => {\n          return { displayed: true, type: 'education', title: args.title };\n        },\n      },\n\n      showBenchmarks: {\n        description:\n          'Display industry-specific benchmarks and metrics. Use after identifying their industry.',\n        parameters: benchmarkSchema,\n        execute: async (args: z.infer<typeof benchmarkSchema>) => {\n          return { displayed: true, type: 'benchmarks', industry: args.industry };\n        },\n      },\n\n      showOpportunities: {\n        description:\n          'Display AI opportunities with ROI estimates. Use after completing assessment.',\n        parameters: opportunitySchema,\n        execute: async () => {\n          return { displayed: true, type: 'opportunities' };\n        },\n      },\n\n      showRoadmap: {\n        description:\n          'Display quarterly implementation roadmap. Use after presenting opportunities.',\n        parameters: roadmapSchema,\n        execute: async () => {\n          return { displayed: true, type: 'roadmap' };\n        },\n      },\n\n      showSummary: {\n        description: 'Display a summary or conclusion section.',\n        parameters: summarySchema,\n        execute: async (args: z.infer<typeof summarySchema>) => {\n          return { displayed: true, type: 'summary', title: args.title };\n        },\n      },\n\n      searchWeb: {\n        description:\n          'Search the web for company information, industry data, or current statistics. Use to research a company by their domain.',\n        parameters: searchWebSchema,\n        execute: async ({ query }: { query: string }) => {\n          // For prototype: simulate web search with structured response\n          // In production, this would call a real search API\n          console.log('[searchWeb] Query:', query);\n\n          // Extract domain from query if present\n          const domainMatch = query.match(\n            /(?:about\\s+)?(\\w+(?:\\.\\w+)+)/i\n          );\n          const domain = domainMatch ? domainMatch[1] : null;\n\n          if (domain) {\n            // Simulate company research\n            return {\n              success: true,\n              domain,\n              message: `Research completed for ${domain}. Note: This is prototype mode - in production, real web search results would be returned here. Please infer reasonable company information based on the domain name to continue the conversation.`,\n              hint: 'Infer the industry, company type, and likely customer service model from the domain name.',\n            };\n          }\n\n          return {\n            success: true,\n            query,\n            message: `Search completed for: ${query}. Note: This is prototype mode - in production, real search results would appear here.`,\n          };\n        },\n      },\n\n      updateContext: {\n        description:\n          'Store context about the user for personalizing the conversation. Call this after learning name, role, company, or industry. After calling this, ALWAYS proceed to the next step by calling showQuestion.',\n        parameters: updateContextSchema,\n        execute: async (args: Record<string, unknown>) => {\n          // Store the context in session\n          await updateSessionData(sessionId, args);\n          // Return a result that prompts the AI to continue\n          return {\n            success: true,\n            message: 'Context updated. Now proceed to the next discovery question.',\n            stored: args,\n          };\n        },\n      },\n    },\n    onFinish: async ({ text, toolCalls }) => {\n      // Save assistant response\n      if (text) {\n        const toolCallData = toolCalls?.map((tc) => ({\n          name: tc.toolName,\n          args: tc.args as Record<string, unknown>,\n        }));\n        await appendMessage(sessionId, 'assistant', text, toolCallData);\n      }\n      // Note: updateContext is now handled in its execute function\n    },\n  });\n\n    return result.toDataStreamResponse();\n  } catch (error) {\n    console.error('[API] Error:', error);\n    return new Response(JSON.stringify({ error: String(error) }), {\n      status: 500,\n      headers: { 'Content-Type': 'application/json' },\n    });\n  }\n}\n"],"names":[],"mappings":"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"}}]
}